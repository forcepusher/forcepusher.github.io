<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="UTF-8">
  <meta http-equiv="Cache-Control" content="no-cache, no-store, must-revalidate">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/monaco-editor/0.52.2/min/vs/loader.min.js"></script>

  <style>
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }

    html,
    body {
      height: 100%;
      overflow: hidden;
      background-color: #1e1e1e;
    }

    #monaco-editor {
      width: 100vw;
      height: 100vh;
    }

    #save-button {
      position: fixed;
      top: 20px;
      right: 40px;
      background: #007acc;
      color: white;
      border: none;
      padding: 12px 24px;
      border-radius: 6px;
      font-size: 14px;
      font-weight: 500;
      cursor: pointer;
      z-index: 1000;
      box-shadow: 0 2px 8px rgba(0, 0, 0, 0.3);
      transition: background-color 0.2s;
      display: none;
    }

    #save-button:hover {
      background: #005a9e;
    }

    #save-button:disabled {
      background: #666;
      cursor: not-allowed;
    }

    #loading {
      position: fixed;
      top: 50%;
      left: 50%;
      transform: translate(-50%, -50%);
      z-index: 1001;
    }

    .spinner {
      width: 40px;
      height: 40px;
      border: 4px solid #3c3c3c;
      border-top: 4px solid #007acc;
      border-radius: 50%;
      animation: spin 1s linear infinite;
    }

    @keyframes spin {
      0% {
        transform: rotate(0deg);
      }

      100% {
        transform: rotate(360deg);
      }
    }
  </style>
</head>

<body>
  <div id="monaco-editor"></div>
  <button id="save-button">Save</button>
  <div id="loading">
    <div class="spinner"></div>
  </div>
  <script>
    require.config({ paths: { 'vs': 'https://cdnjs.cloudflare.com/ajax/libs/monaco-editor/0.52.2/min/vs' } });

    require(['vs/editor/editor.main'], function () {
      fetch('./config.json')
        .then(response => {
          if (!response.ok) {
            throw new Error(`HTTP error! status: ${response.status}`);
          }
          return response.text();
        })
        .then(configText => {
          const editor = monaco.editor.create(document.getElementById('monaco-editor'), {
            value: configText,
            language: 'json',
            theme: 'vs-dark',
            automaticLayout: true,
            minimap: { enabled: false },
            scrollBeyondLastLine: true,
            fontSize: 14,
            wordWrap: 'on',
            formatOnPaste: true,
            formatOnType: true
          });

          window.monacoEditor = editor;

          let storedPassword = null;

          // editor.onDidChangeModelContent(() => {
          //   console.log('Config changed:', editor.getValue());
          // });

          const saveConfig = async () => {
            const saveButton = document.getElementById('save-button');

            try {
              let promptPassword;
              if (storedPassword) {
                promptPassword = storedPassword;
              }
              else {
                promptPassword = prompt('Enter password:');
              }

              saveButton.disabled = true;
              saveButton.textContent = 'Saving...';

              const requestBody = {
                password: promptPassword,
                config: JSON.parse(window.monacoEditor.getValue())
              };

              console.log(JSON.stringify(requestBody));

              const response = await fetch('https://functions.yandexcloud.net/d4ecp8j9q9gsj7k1g6k9', {
                method: 'POST',
                headers: {
                  'Content-Type': 'application/json; charset=utf-8'
                },
                body: JSON.stringify(requestBody)
              });

              if (response.ok) {
                saveButton.textContent = 'Saved!';
                console.log('Save successful');

                storedPassword = promptPassword;

                const responseText = await response.text();
                console.log(responseText);
                const responseJson = JSON.parse(responseText);
                window.monacoEditor.setValue(JSON.stringify(responseJson.config, null, 4));

                setTimeout(() => {
                  saveButton.textContent = 'Save';
                  saveButton.disabled = false;
                }, 2000);
              } else {
                throw new Error(`HTTP error! status: ${response.status}`);
              }

            } catch (error) {
              console.error('Save failed:', error);
              saveButton.textContent = 'Save Failed';
              saveButton.disabled = false;

              setTimeout(() => {
                saveButton.textContent = 'Save';
              }, 3000);
            }
          };

          document.getElementById('save-button').addEventListener('click', saveConfig);
          document.addEventListener('keydown', (event) => {
            if (event.ctrlKey && (event.key === 's' || event.key === 'Ñ‹')) {
              event.preventDefault();
              saveConfig();
            }
          });

          document.getElementById('loading').style.display = 'none';
          document.getElementById('save-button').style.display = 'block';

          console.log('Config.json loaded successfully into Monaco Editor');
        })
        .catch(error => {
          console.error('Error loading config.json:', error);
          window.monacoEditor = editor;
        });
    });
  </script>
</body>

</html>